module ProcessKillLongProcessPosix exposing (main)

import Lune.Prelude exposing (Bool(..), Result(..), Task, Unit, unit)
import Lune.IO as IO
import Lune.Process as Process exposing (ExitStatus(..), Signal(..))
import Lune.Task as Task

assertTrue : Bool -> Task Unit Unit
assertTrue b =
  case b of
    True -> Task.succeed unit

unsafe : Task e a -> Task Unit a
unsafe t =
  do
    r <- Task.fromIO (Task.attempt t)
    case r of
      Ok a -> Task.succeed a

crash : Task Unit Unit
crash =
  assertTrue False

main : Task Unit Unit
main =
  do
    p <- unsafe (Process.spawn (Process.cmd "sh" |> Process.args ["-c", "sleep 10"]))
    _ <- IO.sleepMs 50
    _ <- unsafe (Process.kill p SigTerm)
    r <- unsafe (Task.withTimeout 1000 (Process.wait p))
    case r of
      Err _ -> crash
      Ok _ ->
        Task.succeed unit
