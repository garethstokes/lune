module WithProcessTimeout exposing (main)

import Lune.Prelude exposing (Bool(..), Result(..), Task, Unit, unit)
import Lune.IO as IO
import Lune.Process as Process exposing (ExitStatus(..))
import Lune.Task as Task

assertTrue : Bool -> Task e Unit
assertTrue b =
  case b of
    True -> Task.succeed unit

unsafe : Task e a -> Task Unit a
unsafe t =
  do
    r <- Task.fromIO (Task.attempt t)
    case r of
      Ok a -> Task.succeed a

crash : Task e Unit
crash =
  assertTrue False

assertDead : Task Unit Unit
assertDead =
  do
    status <-
      unsafe
        ( Process.run
            ( Process.cmd "sh"
                |> Process.args ["-c", "pid=$(cat /tmp/lune_withProcess_timeout_pid); kill -0 $pid 2>/dev/null"]
            )
        )
    case status of
      Exited code ->
        case prim_eqInt code 0 of
          True -> crash
          False -> Task.succeed unit

main : Task Unit Unit
main =
  do
    _ <-
      unsafe
        ( Process.withProcess
            ( Process.cmd "sh"
                |> Process.args ["-c", "echo $$ > /tmp/lune_withProcess_timeout_pid; exec sleep 10"]
            )
            (\p ->
              do
                _ <- IO.sleepMs 50
                r <- Task.withTimeout 50 (Process.wait p)
                case r of
                  Ok _ -> crash
                  Err _ -> Task.succeed unit
            )
        )
    _ <- assertDead
    Task.succeed unit
