module WithProcessBasic exposing (main)

import Lune.Prelude exposing (Bool(..), List(..), Maybe(..), Result(..), Task, Unit, unit)
import Lune.Bytes as Bytes
import Lune.List as List
import Lune.Process as Process exposing (ExitStatus(..), Process)
import Lune.String as String
import Lune.Task as Task

assertTrue : Bool -> Task e Unit
assertTrue b =
  case b of
    True -> Task.succeed unit

unsafe : Task e a -> Task Unit a
unsafe t =
  do
    r <- Task.fromIO (Task.attempt t)
    case r of
      Ok a -> Task.succeed a

main : Task Unit Unit
main =
  do
    _ <-
      unsafe
        ( Process.withProcess (Process.cmd "cat") (\p ->
            do
              _ <- Process.writeStdin p (Bytes.fromString "hello\nworld\n")
              _ <- Process.closeStdin p
              out <- readAll p []
              status <- Process.wait p
              case status of
                Exited code ->
                  do
                    _ <- assertTrue (prim_eqInt code 0)
                    _ <- assertTrue (String.contains "hello" (Bytes.toString out))
                    _ <- assertTrue (String.contains "world" (Bytes.toString out))
                    Task.succeed unit
          )
        )
    Task.succeed unit

readAll : Process -> List Bytes.Bytes -> Task Process.ProcessError Bytes.Bytes
readAll p rev =
  do
    m <- Process.readStdout p 4096
    case m of
      Nothing ->
        Task.succeed
          ( List.foldl Bytes.concat Bytes.empty (List.reverse rev)
          )
      Just bs ->
        readAll p (Cons bs rev)
