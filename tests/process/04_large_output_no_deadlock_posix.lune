module ProcessLargeOutputNoDeadlockPosix exposing (main)

import Lune.Prelude exposing (Bool(..), Result(..), Task, Unit, unit)
import Lune.Bytes as Bytes
import Lune.Process as Process exposing (ExitStatus(..))
import Lune.String as String
import Lune.Task as Task

assertTrue : Bool -> Task Unit Unit
assertTrue b =
  case b of
    True -> Task.succeed unit

unsafe : Task e a -> Task Unit a
unsafe t =
  do
    r <- Task.fromIO (Task.attempt t)
    case r of
      Ok a -> Task.succeed a

main : Task Unit Unit
main =
  do
    r <- unsafe (Process.runCapture (Process.cmd "sh" |> Process.args ["-c", "i=0; while [ $i -lt 2000 ]; do echo out$i; echo err$i 1>&2; i=$((i+1)); done"]))
    case r.status of
      Exited code -> do
        _ <- assertTrue (prim_eqInt code 0)
        _ <- assertTrue (String.contains "out1999" (Bytes.toString r.stdout))
        _ <- assertTrue (String.contains "err1999" (Bytes.toString r.stderr))
        Task.succeed unit
