Module {modName = "HealthAgent", modExports = [ExposeValue "main"], modImports = [Import {impName = "Lune.IO", impAs = Just "IO", impExposing = Nothing},Import {impName = "Lune.Task", impAs = Just "Task", impExposing = Nothing},Import {impName = "Lune.String", impAs = Just "Str", impExposing = Nothing},Import {impName = "Lune.Int", impAs = Just "Int", impExposing = Nothing},Import {impName = "Lune.Float", impAs = Just "Float", impExposing = Nothing},Import {impName = "Lune.List", impAs = Just "List", impExposing = Nothing},Import {impName = "Lune.Json", impAs = Just "RawJson", impExposing = Just [ExposeType "Json" ExposeOpaque]},Import {impName = "Lune.Json.Decode", impAs = Just "D", impExposing = Nothing},Import {impName = "Lune.Json.Encode", impAs = Just "E", impExposing = Nothing},Import {impName = "Template", impAs = Nothing, impExposing = Just [ExposeValue "render"]},Import {impName = "Nova", impAs = Nothing, impExposing = Just [ExposeValue "newClient",ExposeValue "provider",ExposeValue "withModel",ExposeValue "tool"]},Import {impName = "Nova.Core", impAs = Just "Core", impExposing = Just [ExposeType "Error" ExposeAll,ExposeType "Provider" ExposeOpaque,ExposeType "Response" ExposeOpaque]},Import {impName = "Nova.Tool", impAs = Just "Tool", impExposing = Nothing},Import {impName = "Nova.Runtime", impAs = Just "Runtime", impExposing = Just [ExposeType "RuntimeConfig" ExposeOpaque,ExposeType "ToolExecError" ExposeAll]}], modDecls = [DeclTypeAlias [] "DiskUsage" [] (TypeRecord [("mountPoint",TypeCon "String",[]),("totalGb",TypeCon "Float",[]),("usedGb",TypeCon "Float",[]),("percentUsed",TypeCon "Int",[])]),DeclTypeAlias [] "MemoryUsage" [] (TypeRecord [("totalMb",TypeCon "Int",[]),("usedMb",TypeCon "Int",[]),("availableMb",TypeCon "Int",[]),("swapUsedMb",TypeCon "Int",[])]),DeclTypeAlias [] "ProcessInfo" [] (TypeRecord [("pid",TypeCon "Int",[]),("name",TypeCon "String",[]),("cpuPercent",TypeCon "Float",[]),("memoryPercent",TypeCon "Float",[])]),DeclTypeAlias [] "ServiceStatus" [] (TypeRecord [("name",TypeCon "String",[]),("isRunning",TypeCon "Bool",[]),("uptime",TypeApp (TypeCon "Maybe") (TypeCon "String"),[])]),DeclTypeAlias [] "HealthReport" [] (TypeRecord [("disks",TypeApp (TypeCon "List") (TypeCon "DiskUsage"),[]),("memory",TypeCon "MemoryUsage",[]),("topProcesses",TypeApp (TypeCon "List") (TypeCon "ProcessInfo"),[]),("services",TypeApp (TypeCon "List") (TypeCon "ServiceStatus"),[])]),DeclType "Severity" [] [TypeCtor "Critical" [],TypeCtor "Warning" [],TypeCtor "Info" []],DeclTypeAlias [] "Issue" [] (TypeRecord [("severity",TypeCon "Severity",[]),("summary",TypeCon "String",[]),("details",TypeCon "String",[])]),DeclTypeAlias [] "ProposedAction" [] (TypeRecord [("id",TypeCon "Int",[]),("issue",TypeCon "String",[]),("action",TypeCon "String",[]),("command",TypeCon "String",[]),("risk",TypeCon "String",[]),("expectedOutcome",TypeCon "String",[])]),DeclTypeAlias [] "HealthAnalysis" [] (TypeRecord [("issues",TypeApp (TypeCon "List") (TypeCon "Issue"),[]),("actions",TypeApp (TypeCon "List") (TypeCon "ProposedAction"),[])]),DeclType "AgentError" [] [TypeCtor "LlmError" [TypeCon "Core.Error"],TypeCtor "DecodeError" [TypeCon "String"]],DeclTypeSig "encodeDiskUsage" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "DiskUsage") (TypeCon "Json")}),DeclValue "encodeDiskUsage" [PVar "d"] (App (FieldAccess (Var "E") "object") (App (App (Var "Cons") (RecordLiteral [("key",StringLit "mountPoint"),("value",App (FieldAccess (Var "E") "string") (FieldAccess (Var "d") "mountPoint"))])) (App (App (Var "Cons") (RecordLiteral [("key",StringLit "totalGb"),("value",App (FieldAccess (Var "E") "float") (FieldAccess (Var "d") "totalGb"))])) (App (App (Var "Cons") (RecordLiteral [("key",StringLit "usedGb"),("value",App (FieldAccess (Var "E") "float") (FieldAccess (Var "d") "usedGb"))])) (App (App (Var "Cons") (RecordLiteral [("key",StringLit "percentUsed"),("value",App (FieldAccess (Var "E") "int") (FieldAccess (Var "d") "percentUsed"))])) (Var "Nil")))))),DeclTypeSig "encodeMemoryUsage" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "MemoryUsage") (TypeCon "Json")}),DeclValue "encodeMemoryUsage" [PVar "m"] (App (FieldAccess (Var "E") "object") (App (App (Var "Cons") (RecordLiteral [("key",StringLit "totalMb"),("value",App (FieldAccess (Var "E") "int") (FieldAccess (Var "m") "totalMb"))])) (App (App (Var "Cons") (RecordLiteral [("key",StringLit "usedMb"),("value",App (FieldAccess (Var "E") "int") (FieldAccess (Var "m") "usedMb"))])) (App (App (Var "Cons") (RecordLiteral [("key",StringLit "availableMb"),("value",App (FieldAccess (Var "E") "int") (FieldAccess (Var "m") "availableMb"))])) (App (App (Var "Cons") (RecordLiteral [("key",StringLit "swapUsedMb"),("value",App (FieldAccess (Var "E") "int") (FieldAccess (Var "m") "swapUsedMb"))])) (Var "Nil")))))),DeclTypeSig "encodeProcessInfo" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "ProcessInfo") (TypeCon "Json")}),DeclValue "encodeProcessInfo" [PVar "p"] (App (FieldAccess (Var "E") "object") (App (App (Var "Cons") (RecordLiteral [("key",StringLit "pid"),("value",App (FieldAccess (Var "E") "int") (FieldAccess (Var "p") "pid"))])) (App (App (Var "Cons") (RecordLiteral [("key",StringLit "name"),("value",App (FieldAccess (Var "E") "string") (FieldAccess (Var "p") "name"))])) (App (App (Var "Cons") (RecordLiteral [("key",StringLit "cpuPercent"),("value",App (FieldAccess (Var "E") "float") (FieldAccess (Var "p") "cpuPercent"))])) (App (App (Var "Cons") (RecordLiteral [("key",StringLit "memoryPercent"),("value",App (FieldAccess (Var "E") "float") (FieldAccess (Var "p") "memoryPercent"))])) (Var "Nil")))))),DeclTypeSig "encodeUptime" (QualType {qualConstraints = [], qualType = TypeArrow (TypeApp (TypeCon "Maybe") (TypeCon "String")) (TypeCon "Json")}),DeclValue "encodeUptime" [PVar "maybeUptime"] (Case (Var "maybeUptime") [Alt (PCon "Nothing" []) (FieldAccess (Var "E") "null"),Alt (PCon "Just" [PVar "u"]) (App (FieldAccess (Var "E") "string") (Var "u"))]),DeclTypeSig "encodeServiceStatus" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "ServiceStatus") (TypeCon "Json")}),DeclValue "encodeServiceStatus" [PVar "s"] (App (FieldAccess (Var "E") "object") (App (App (Var "Cons") (RecordLiteral [("key",StringLit "name"),("value",App (FieldAccess (Var "E") "string") (FieldAccess (Var "s") "name"))])) (App (App (Var "Cons") (RecordLiteral [("key",StringLit "isRunning"),("value",App (FieldAccess (Var "E") "bool") (FieldAccess (Var "s") "isRunning"))])) (App (App (Var "Cons") (RecordLiteral [("key",StringLit "uptime"),("value",App (Var "encodeUptime") (FieldAccess (Var "s") "uptime"))])) (Var "Nil"))))),DeclTypeSig "encodeHealthReport" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "HealthReport") (TypeCon "Json")}),DeclValue "encodeHealthReport" [PVar "r"] (App (FieldAccess (Var "E") "object") (App (App (Var "Cons") (RecordLiteral [("key",StringLit "disks"),("value",App (App (FieldAccess (Var "E") "list") (Var "encodeDiskUsage")) (FieldAccess (Var "r") "disks"))])) (App (App (Var "Cons") (RecordLiteral [("key",StringLit "memory"),("value",App (Var "encodeMemoryUsage") (FieldAccess (Var "r") "memory"))])) (App (App (Var "Cons") (RecordLiteral [("key",StringLit "topProcesses"),("value",App (App (FieldAccess (Var "E") "list") (Var "encodeProcessInfo")) (FieldAccess (Var "r") "topProcesses"))])) (App (App (Var "Cons") (RecordLiteral [("key",StringLit "services"),("value",App (App (FieldAccess (Var "E") "list") (Var "encodeServiceStatus")) (FieldAccess (Var "r") "services"))])) (Var "Nil")))))),DeclTypeSig "decodeSeverity" (QualType {qualConstraints = [], qualType = TypeApp (TypeCon "D.Decoder") (TypeCon "Severity")}),DeclValue "decodeSeverity" [] (App (App (FieldAccess (Var "D") "andThen") (Lam [PVar "s"] (Case (Var "s") [Alt (PString "critical") (App (FieldAccess (Var "D") "succeed") (Var "Critical")),Alt (PString "warning") (App (FieldAccess (Var "D") "succeed") (Var "Warning")),Alt (PString "info") (App (FieldAccess (Var "D") "succeed") (Var "Info")),Alt PWildcard (App (FieldAccess (Var "D") "fail") (App (App (FieldAccess (Var "Str") "append") (StringLit "Unknown severity: ")) (Var "s")))]))) (FieldAccess (Var "D") "string")),DeclTypeSig "decodeIssue" (QualType {qualConstraints = [], qualType = TypeApp (TypeCon "D.Decoder") (TypeCon "Issue")}),DeclValue "decodeIssue" [] (App (App (App (App (FieldAccess (Var "D") "map3") (Lam [PVar "sev",PVar "sum",PVar "det"] (RecordLiteral [("severity",Var "sev"),("summary",Var "sum"),("details",Var "det")]))) (App (App (FieldAccess (Var "D") "field") (StringLit "severity")) (Var "decodeSeverity"))) (App (App (FieldAccess (Var "D") "field") (StringLit "summary")) (FieldAccess (Var "D") "string"))) (App (App (FieldAccess (Var "D") "field") (StringLit "details")) (FieldAccess (Var "D") "string"))),DeclTypeSig "decodeProposedAction" (QualType {qualConstraints = [], qualType = TypeApp (TypeCon "D.Decoder") (TypeCon "ProposedAction")}),DeclValue "decodeProposedAction" [] (App (App (FieldAccess (Var "D") "andThen") (Lam [PVar "exp"] (App (App (App (App (App (App (FieldAccess (Var "D") "map5") (Lam [PVar "id",PVar "iss",PVar "act",PVar "cmd",PVar "risk"] (RecordLiteral [("id",Var "id"),("issue",Var "iss"),("action",Var "act"),("command",Var "cmd"),("risk",Var "risk"),("expectedOutcome",Var "exp")]))) (App (App (FieldAccess (Var "D") "field") (StringLit "id")) (FieldAccess (Var "D") "int"))) (App (App (FieldAccess (Var "D") "field") (StringLit "issue")) (FieldAccess (Var "D") "string"))) (App (App (FieldAccess (Var "D") "field") (StringLit "action")) (FieldAccess (Var "D") "string"))) (App (App (FieldAccess (Var "D") "field") (StringLit "command")) (FieldAccess (Var "D") "string"))) (App (App (FieldAccess (Var "D") "field") (StringLit "risk")) (FieldAccess (Var "D") "string"))))) (App (App (FieldAccess (Var "D") "field") (StringLit "expectedOutcome")) (FieldAccess (Var "D") "string"))),DeclTypeSig "decodeHealthAnalysis" (QualType {qualConstraints = [], qualType = TypeApp (TypeCon "D.Decoder") (TypeCon "HealthAnalysis")}),DeclValue "decodeHealthAnalysis" [] (App (App (App (FieldAccess (Var "D") "map2") (Lam [PVar "iss",PVar "acts"] (RecordLiteral [("issues",Var "iss"),("actions",Var "acts")]))) (App (App (FieldAccess (Var "D") "field") (StringLit "issues")) (App (FieldAccess (Var "D") "list") (Var "decodeIssue")))) (App (App (FieldAccess (Var "D") "field") (StringLit "actions")) (App (FieldAccess (Var "D") "list") (Var "decodeProposedAction")))),DeclTypeSig "mockDiskCheck" (QualType {qualConstraints = [], qualType = TypeApp (TypeApp (TypeCon "Task") (TypeVar "e")) (TypeApp (TypeCon "List") (TypeCon "DiskUsage"))}),DeclValue "mockDiskCheck" [] (App (FieldAccess (Var "Task") "succeed") (App (App (Var "Cons") (RecordLiteral [("mountPoint",StringLit "/"),("totalGb",FloatLit 50.0),("usedGb",FloatLit 35.0),("percentUsed",IntLit 70)])) (App (App (Var "Cons") (RecordLiteral [("mountPoint",StringLit "/var"),("totalGb",FloatLit 20.0),("usedGb",FloatLit 18.8),("percentUsed",IntLit 94)])) (Var "Nil")))),DeclTypeSig "mockMemoryCheck" (QualType {qualConstraints = [], qualType = TypeApp (TypeApp (TypeCon "Task") (TypeVar "e")) (TypeCon "MemoryUsage")}),DeclValue "mockMemoryCheck" [] (App (FieldAccess (Var "Task") "succeed") (RecordLiteral [("totalMb",IntLit 16384),("usedMb",IntLit 12800),("availableMb",IntLit 3584),("swapUsedMb",IntLit 512)])),DeclTypeSig "mockProcessCheck" (QualType {qualConstraints = [], qualType = TypeApp (TypeApp (TypeCon "Task") (TypeVar "e")) (TypeApp (TypeCon "List") (TypeCon "ProcessInfo"))}),DeclValue "mockProcessCheck" [] (App (FieldAccess (Var "Task") "succeed") (App (App (Var "Cons") (RecordLiteral [("pid",IntLit 1234),("name",StringLit "node"),("cpuPercent",FloatLit 45.2),("memoryPercent",FloatLit 78.0)])) (App (App (Var "Cons") (RecordLiteral [("pid",IntLit 5678),("name",StringLit "postgres"),("cpuPercent",FloatLit 12.5),("memoryPercent",FloatLit 15.3)])) (Var "Nil")))),DeclTypeSig "mockServiceCheck" (QualType {qualConstraints = [], qualType = TypeApp (TypeApp (TypeCon "Task") (TypeVar "e")) (TypeApp (TypeCon "List") (TypeCon "ServiceStatus"))}),DeclValue "mockServiceCheck" [] (App (FieldAccess (Var "Task") "succeed") (App (App (Var "Cons") (RecordLiteral [("name",StringLit "nginx"),("isRunning",Var "True"),("uptime",App (Var "Just") (StringLit "3d 12h"))])) (App (App (Var "Cons") (RecordLiteral [("name",StringLit "redis"),("isRunning",Var "False"),("uptime",Var "Nothing")])) (Var "Nil")))),DeclTypeSig "collectHealthReport" (QualType {qualConstraints = [], qualType = TypeApp (TypeApp (TypeCon "Task") (TypeVar "e")) (TypeCon "HealthReport")}),DeclValue "collectHealthReport" [] (DoBlock [BindStmt (PVar "disks") (Var "mockDiskCheck"),BindStmt (PVar "memory") (Var "mockMemoryCheck"),BindStmt (PVar "processes") (Var "mockProcessCheck"),BindStmt (PVar "services") (Var "mockServiceCheck"),ExprStmt (App (FieldAccess (Var "Task") "succeed") (RecordLiteral [("disks",Var "disks"),("memory",Var "memory"),("topProcesses",Var "processes"),("services",Var "services")]))]),DeclTypeSig "showSeverity" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "Severity") (TypeCon "String")}),DeclValue "showSeverity" [PVar "sev"] (Case (Var "sev") [Alt (PCon "Critical" []) (StringLit "CRITICAL"),Alt (PCon "Warning" []) (StringLit "WARNING"),Alt (PCon "Info" []) (StringLit "INFO")]),DeclTypeSig "showIssue" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "Issue") (TypeCon "String")}),DeclValue "showIssue" [PVar "iss"] (App (App (FieldAccess (Var "Str") "join") (StringLit "")) (App (App (Var "Cons") (StringLit "  * [")) (App (App (Var "Cons") (App (Var "showSeverity") (FieldAccess (Var "iss") "severity"))) (App (App (Var "Cons") (StringLit "] ")) (App (App (Var "Cons") (FieldAccess (Var "iss") "summary")) (Var "Nil")))))),DeclTypeSig "showIssues" (QualType {qualConstraints = [], qualType = TypeArrow (TypeApp (TypeCon "List") (TypeCon "Issue")) (TypeCon "String")}),DeclValue "showIssues" [PVar "issues"] (Case (Var "issues") [Alt (PCon "Nil" []) (StringLit "No issues found."),Alt PWildcard (App (App (FieldAccess (Var "Str") "join") (StringLit "")) (App (App (Var "Cons") (StringLit "Issues found:\n")) (App (App (Var "Cons") (App (App (FieldAccess (Var "Str") "join") (StringLit "\n")) (App (App (FieldAccess (Var "List") "map") (Var "showIssue")) (Var "issues")))) (Var "Nil"))))]),DeclTypeSig "showAction" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "Int") (TypeArrow (TypeCon "Int") (TypeArrow (TypeCon "ProposedAction") (TypeCon "String")))}),DeclValue "showAction" [PVar "current",PVar "total",PVar "act"] (App (App (FieldAccess (Var "Str") "join") (StringLit "")) (App (App (Var "Cons") (StringLit "+-------------------------------------------------+\n")) (App (App (Var "Cons") (StringLit "| Action ")) (App (App (Var "Cons") (App (FieldAccess (Var "Str") "fromInt") (Var "current"))) (App (App (Var "Cons") (StringLit " of ")) (App (App (Var "Cons") (App (FieldAccess (Var "Str") "fromInt") (Var "total"))) (App (App (Var "Cons") (StringLit " [")) (App (App (Var "Cons") (FieldAccess (Var "act") "risk")) (App (App (Var "Cons") (StringLit " risk]\n")) (App (App (Var "Cons") (StringLit "|\n")) (App (App (Var "Cons") (StringLit "| Issue: ")) (App (App (Var "Cons") (FieldAccess (Var "act") "issue")) (App (App (Var "Cons") (StringLit "\n")) (App (App (Var "Cons") (StringLit "|\n")) (App (App (Var "Cons") (StringLit "| Proposed: ")) (App (App (Var "Cons") (FieldAccess (Var "act") "action")) (App (App (Var "Cons") (StringLit "\n")) (App (App (Var "Cons") (StringLit "| Command:  ")) (App (App (Var "Cons") (FieldAccess (Var "act") "command")) (App (App (Var "Cons") (StringLit "\n")) (App (App (Var "Cons") (StringLit "| Expected: ")) (App (App (Var "Cons") (FieldAccess (Var "act") "expectedOutcome")) (App (App (Var "Cons") (StringLit "\n")) (App (App (Var "Cons") (StringLit "+-------------------------------------------------+")) (Var "Nil"))))))))))))))))))))))))),DeclTypeSig "mockHealthProvider" (QualType {qualConstraints = [], qualType = TypeCon "Provider"}),DeclValue "mockHealthProvider" [] (App (Var "provider") (StringLit "mock-health")),DeclTypeSig "mockHealthCall" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "Core.ProviderConfig") (TypeArrow (TypeCon "String") (TypeArrow (TypeCon "String") (TypeApp (TypeCon "IO") (TypeApp (TypeApp (TypeCon "Result") (TypeCon "Core.Error")) (TypeCon "Response")))))}),DeclValue "mockHealthCall" [PWildcard,PWildcard,PWildcard] (App (App (Var "<|") (FieldAccess (Var "IO") "pure")) (App (Var "Ok") (RecordLiteral [("text",Var "mockHealthAnalysisJson"),("usage",App (Var "Just") (RecordLiteral [("inputTokens",IntLit 100),("outputTokens",IntLit 50),("totalTokens",IntLit 150)]))]))),DeclTypeSig "mockHealthAnalysisJson" (QualType {qualConstraints = [], qualType = TypeCon "String"}),DeclValue "mockHealthAnalysisJson" [] (App (Var "render") (TemplateLit TemplateBlock [TemplateText "{\n  \"issues\": [\n    {\n      \"severity\": \"critical\",\n      \"summary\": \"Disk /var is 94% full\",\n      \"details\": \"Only 1.2GB remaining on /var partition\"\n    },\n    {\n      \"severity\": \"warning\",\n      \"summary\": \"High memory usage\",\n      \"details\": \"Process 'node' using 78% of available memory\"\n    },\n    {\n      \"severity\": \"warning\",\n      \"summary\": \"Service redis is down\",\n      \"details\": \"Redis service is not running\"\n    }\n  ],\n  \"actions\": [\n    {\n      \"id\": 1,\n      \"issue\": \"Disk /var is 94% full\",\n      \"action\": \"Clear journal logs older than 7 days\",\n      \"command\": \"journalctl --vacuum-time=7d\",\n      \"risk\": \"low\",\n      \"expectedOutcome\": \"Free approximately 1-2GB\"\n    },\n    {\n      \"id\": 2,\n      \"issue\": \"Service redis is down\",\n      \"action\": \"Restart redis service\",\n      \"command\": \"systemctl restart redis\",\n      \"risk\": \"medium\",\n      \"expectedOutcome\": \"Redis service will be available\"\n    }\n  ]\n}"])),DeclTypeSig "mockHealthProviderImpl" (QualType {qualConstraints = [], qualType = TypeCon "Core.ProviderImpl"}),DeclValue "mockHealthProviderImpl" [] (RecordLiteral [("id",Var "mockHealthProvider"),("call",Var "mockHealthCall"),("capabilities",FieldAccess (Var "Core") "setEmpty")]),DeclTypeSig "analysisSystemPrompt" (QualType {qualConstraints = [], qualType = TypeCon "String"}),DeclValue "analysisSystemPrompt" [] (App (Var "render") (TemplateLit TemplateBlock [TemplateText "You are a Linux sysadmin assistant. Analyze these system\nhealth metrics and identify issues that need attention.\n\nSeverity guidelines:\n- Critical: System at risk of failure (disk >90%, OOM imminent)\n- Warning: Degraded performance or trending toward critical\n- Info: Notable but not actionable\n\nFor each issue, propose a concrete remediation action with\nthe exact command to run. Assess risk level:\n- low: Safe, no service impact (clear caches, rotate logs)\n- medium: Brief impact (restart service, kill process)\n- high: Potential data loss or extended downtime\n\nReturn actions in priority order (most urgent first)."])),DeclTypeSig "buildAnalysisPrompt" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "HealthReport") (TypeCon "String")}),DeclValue "buildAnalysisPrompt" [PVar "report"] (App (App (FieldAccess (Var "Str") "join") (StringLit "")) (App (App (Var "Cons") (Var "analysisSystemPrompt")) (App (App (Var "Cons") (StringLit "\n\nHealth Report:\n")) (App (App (Var "Cons") (App (FieldAccess (Var "RawJson") "stringify") (App (Var "encodeHealthReport") (Var "report")))) (Var "Nil"))))),DeclTypeSig "mockProviderRegistry" (QualType {qualConstraints = [], qualType = TypeCon "Core.ProviderRegistry"}),DeclValue "mockProviderRegistry" [] (App (App (App (App (FieldAccess (Var "Core") "dictInsert") (FieldAccess (Var "Nova") "providerEq")) (Var "mockHealthProvider")) (Var "mockHealthProviderImpl")) (FieldAccess (Var "Core") "defaultProviderRegistry")),DeclTypeSig "makeClient" (QualType {qualConstraints = [], qualType = TypeCon "Nova.Client"}),DeclValue "makeClient" [] (App (App (App (Var "newClient") (Var "mockProviderRegistry")) (Var "mockHealthProvider")) (StringLit "health-analyzer")),DeclTypeSig "analyzeHealth" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "HealthReport") (TypeApp (TypeApp (TypeCon "Task") (TypeCon "AgentError")) (TypeCon "HealthAnalysis"))}),DeclValue "analyzeHealth" [PVar "report"] (DoBlock [LetStmt "prompt" (App (Var "buildAnalysisPrompt") (Var "report")),BindStmt (PVar "analysisJson") (App (App (FieldAccess (Var "Task") "mapError") (Var "LlmError")) (App (App (Var "tool") (Var "makeClient")) (Var "prompt"))),ExprStmt (Case (App (App (FieldAccess (Var "D") "decodeValue") (Var "decodeHealthAnalysis")) (Var "analysisJson")) [Alt (PCon "Err" [PVar "decodeErr"]) (App (FieldAccess (Var "Task") "fail") (App (Var "DecodeError") (FieldAccess (Var "decodeErr") "message"))),Alt (PCon "Ok" [PVar "analysis"]) (App (FieldAccess (Var "Task") "succeed") (Var "analysis"))])]),DeclTypeSig "displayAnalysis" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "HealthAnalysis") (TypeApp (TypeApp (TypeCon "Task") (TypeVar "e")) (TypeCon "Unit"))}),DeclValue "displayAnalysis" [PVar "analysis"] (DoBlock [ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "")),ExprStmt (App (FieldAccess (Var "IO") "println") (App (Var "showIssues") (FieldAccess (Var "analysis") "issues"))),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "")),ExprStmt (Case (FieldAccess (Var "analysis") "actions") [Alt (PCon "Nil" []) (App (FieldAccess (Var "IO") "println") (StringLit "No remediation actions proposed.")),Alt PWildcard (DoBlock [LetStmt "count" (App (FieldAccess (Var "List") "length") (FieldAccess (Var "analysis") "actions")),ExprStmt (App (FieldAccess (Var "IO") "println") (App (App (FieldAccess (Var "Str") "join") (StringLit "")) (App (App (Var "Cons") (StringLit "Proposed ")) (App (App (Var "Cons") (App (FieldAccess (Var "Str") "fromInt") (Var "count"))) (App (App (Var "Cons") (StringLit " remediation actions:")) (Var "Nil")))))),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "")),ExprStmt (App (App (Var "processActions") (Var "count")) (FieldAccess (Var "analysis") "actions"))])])]),DeclTypeSig "showAgentError" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "AgentError") (TypeCon "String")}),DeclValue "showAgentError" [PVar "err"] (Case (Var "err") [Alt (PCon "LlmError" [PVar "e"]) (App (App (FieldAccess (Var "Str") "join") (StringLit "")) (App (App (Var "Cons") (StringLit "LLM analysis failed: ")) (App (App (Var "Cons") (App (FieldAccess (Var "Nova") "showError") (Var "e"))) (Var "Nil")))),Alt (PCon "DecodeError" [PVar "msg"]) (App (App (FieldAccess (Var "Str") "join") (StringLit "")) (App (App (Var "Cons") (StringLit "Failed to decode response: ")) (App (App (Var "Cons") (Var "msg")) (Var "Nil"))))]),DeclType "ApprovalResult" [] [TypeCtor "Approved" [],TypeCtor "Skipped" [],TypeCtor "Quit" []],DeclTypeSig "promptForApproval" (QualType {qualConstraints = [], qualType = TypeApp (TypeApp (TypeCon "Task") (TypeVar "e")) (TypeCon "ApprovalResult")}),DeclValue "promptForApproval" [] (DoBlock [ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "Execute this action? [y/n/q] ")),BindStmt (PVar "input") (FieldAccess (Var "IO") "readLine"),ExprStmt (Case (Var "input") [Alt (PString "y") (App (FieldAccess (Var "Task") "succeed") (Var "Approved")),Alt (PString "n") (App (FieldAccess (Var "Task") "succeed") (Var "Skipped")),Alt (PString "q") (App (FieldAccess (Var "Task") "succeed") (Var "Quit")),Alt PWildcard (DoBlock [ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "Please enter y, n, or q")),ExprStmt (Var "promptForApproval")])])]),DeclTypeSig "mockExecuteCommand" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "String") (TypeApp (TypeApp (TypeCon "Task") (TypeVar "e")) (TypeCon "String"))}),DeclValue "mockExecuteCommand" [PVar "cmd"] (App (FieldAccess (Var "Task") "succeed") (App (App (FieldAccess (Var "Str") "join") (StringLit "")) (App (App (Var "Cons") (StringLit "[MOCK] Would execute: ")) (App (App (Var "Cons") (Var "cmd")) (Var "Nil"))))),DeclTypeSig "processActions" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "Int") (TypeArrow (TypeApp (TypeCon "List") (TypeCon "ProposedAction")) (TypeApp (TypeApp (TypeCon "Task") (TypeVar "e")) (TypeCon "Unit")))}),DeclValue "processActions" [PVar "total",PVar "actions"] (App (App (App (Var "processActionsGo") (IntLit 1)) (Var "total")) (Var "actions")),DeclTypeSig "processActionsGo" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "Int") (TypeArrow (TypeCon "Int") (TypeArrow (TypeApp (TypeCon "List") (TypeCon "ProposedAction")) (TypeApp (TypeApp (TypeCon "Task") (TypeVar "e")) (TypeCon "Unit"))))}),DeclValue "processActionsGo" [PVar "current",PVar "total",PVar "actions"] (Case (Var "actions") [Alt (PCon "Nil" []) (DoBlock [ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "All actions processed.")),ExprStmt (App (FieldAccess (Var "Task") "succeed") (Var "unit"))]),Alt (PCon "Cons" [PVar "act",PVar "rest"]) (DoBlock [ExprStmt (App (FieldAccess (Var "IO") "println") (App (App (App (Var "showAction") (Var "current")) (Var "total")) (Var "act"))),BindStmt (PVar "approval") (Var "promptForApproval"),ExprStmt (Case (Var "approval") [Alt (PCon "Quit" []) (DoBlock [ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "Quitting. Remaining actions skipped.")),ExprStmt (App (FieldAccess (Var "Task") "succeed") (Var "unit"))]),Alt (PCon "Skipped" []) (DoBlock [ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "Action skipped.")),ExprStmt (App (App (App (Var "processActionsGo") (App (App (FieldAccess (Var "Int") "add") (Var "current")) (IntLit 1))) (Var "total")) (Var "rest"))]),Alt (PCon "Approved" []) (DoBlock [BindStmt (PVar "result") (App (Var "mockExecuteCommand") (FieldAccess (Var "act") "command")),ExprStmt (App (FieldAccess (Var "IO") "println") (Var "result")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "Action completed.")),ExprStmt (App (App (App (Var "processActionsGo") (App (App (FieldAccess (Var "Int") "add") (Var "current")) (IntLit 1))) (Var "total")) (Var "rest"))])])])]),DeclTypeSig "runAgent" (QualType {qualConstraints = [], qualType = TypeApp (TypeApp (TypeCon "Task") (TypeCon "AgentError")) (TypeCon "Unit")}),DeclValue "runAgent" [] (DoBlock [ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "Collecting system health data...")),BindStmt (PVar "report") (App (App (FieldAccess (Var "Task") "mapError") (Lam [PWildcard] (App (Var "DecodeError") (StringLit "unreachable")))) (Var "collectHealthReport")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "Health data collected.")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "Analyzing with LLM...")),BindStmt (PVar "analysis") (App (Var "analyzeHealth") (Var "report")),ExprStmt (App (Var "displayAnalysis") (Var "analysis"))]),DeclTypeSig "main" (QualType {qualConstraints = [], qualType = TypeApp (TypeApp (TypeCon "Task") (TypeCon "Unit")) (TypeCon "Unit")}),DeclValue "main" [] (DoBlock [ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "=== Health Agent ===")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "")),BindStmt (PVar "result") (App (FieldAccess (Var "Task") "result") (Var "runAgent")),ExprStmt (Case (Var "result") [Alt (PCon "Ok" [PWildcard]) (App (FieldAccess (Var "Task") "succeed") (Var "unit")),Alt (PCon "Err" [PVar "e"]) (App (FieldAccess (Var "IO") "println") (App (Var "showAgentError") (Var "e")))])])]}
