Module {modName = "DatabaseTransaction", modExports = [ExposeValue "main"], modImports = [Import {impName = "Lune.IO", impAs = Just "IO", impExposing = Nothing},Import {impName = "Lune.Prelude", impAs = Nothing, impExposing = Just [ExposeType "IO" ExposeOpaque,ExposeType "Result" ExposeAll,ExposeType "Unit" ExposeOpaque,ExposeType "List" ExposeAll,ExposeType "Maybe" ExposeAll,ExposeType "Int" ExposeOpaque,ExposeType "String" ExposeOpaque,ExposeType "Bool" ExposeAll]},Import {impName = "Lune.Database", impAs = Just "Database", impExposing = Just [ExposeType "DbConn" ExposeOpaque,ExposeType "DbError" ExposeAll,ExposeType "DbValue" ExposeAll]},Import {impName = "Lune.Database.Decode", impAs = Just "Decode", impExposing = Just [ExposeType "Decoder" ExposeOpaque]},Import {impName = "Lune.Database.Query", impAs = Just "Query", impExposing = Just [ExposeType "Table" ExposeOpaque,ExposeType "Column" ExposeOpaque,ExposeType "Query" ExposeOpaque,ExposeType "Order" ExposeAll]},Import {impName = "Lune.Database.Postgres", impAs = Just "Postgres", impExposing = Nothing},Import {impName = "Lune.String", impAs = Just "Str", impExposing = Nothing}], modDecls = [DeclTypeSig "users" (QualType {qualConstraints = [], qualType = TypeCon "Table"}),DeclValue "users" [] (App (FieldAccess (Var "Query") "table") (StringLit "users")),DeclTypeSig "users_id" (QualType {qualConstraints = [], qualType = TypeApp (TypeCon "Column") (TypeCon "Int")}),DeclValue "users_id" [] (App (App (FieldAccess (Var "Query") "column") (Var "users")) (StringLit "id")),DeclTypeSig "users_name" (QualType {qualConstraints = [], qualType = TypeApp (TypeCon "Column") (TypeCon "String")}),DeclValue "users_name" [] (App (App (FieldAccess (Var "Query") "column") (Var "users")) (StringLit "name")),DeclTypeSig "users_email" (QualType {qualConstraints = [], qualType = TypeApp (TypeCon "Column") (TypeCon "String")}),DeclValue "users_email" [] (App (App (FieldAccess (Var "Query") "column") (Var "users")) (StringLit "email")),DeclTypeAlias "User" [] (TypeRecord [("id",TypeCon "Int"),("name",TypeCon "String"),("email",TypeCon "String")]),DeclTypeSig "userDecoder" (QualType {qualConstraints = [], qualType = TypeApp (TypeCon "Decoder") (TypeCon "User")}),DeclValue "userDecoder" [] (App (App (App (App (FieldAccess (Var "Decode") "map3") (Lam [PVar "id",PVar "name",PVar "email"] (RecordLiteral [("id",Var "id"),("name",Var "name"),("email",Var "email")]))) (App (App (FieldAccess (Var "Decode") "index") (IntLit 0)) (FieldAccess (Var "Decode") "int"))) (App (App (FieldAccess (Var "Decode") "index") (IntLit 1)) (FieldAccess (Var "Decode") "string"))) (App (App (FieldAccess (Var "Decode") "index") (IntLit 2)) (FieldAccess (Var "Decode") "string"))),DeclTypeSig "createUsers" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "DbConn") (TypeArrow (TypeApp (TypeCon "List") (TypeRecord [("name",TypeCon "String"),("email",TypeCon "String")])) (TypeApp (TypeCon "IO") (TypeApp (TypeApp (TypeCon "Result") (TypeCon "DbError")) (TypeApp (TypeCon "List") (TypeCon "User")))))}),DeclValue "createUsers" [PVar "conn",PVar "newUsers"] (App (App (FieldAccess (Var "Postgres") "transaction") (Var "conn")) (Lam [PVar "tx"] (App (App (App (Var "createUsersHelper") (Var "tx")) (Var "newUsers")) (Var "Nil")))),DeclTypeSig "createUsersHelper" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "DbConn") (TypeArrow (TypeApp (TypeCon "List") (TypeRecord [("name",TypeCon "String"),("email",TypeCon "String")])) (TypeArrow (TypeApp (TypeCon "List") (TypeCon "User")) (TypeApp (TypeCon "IO") (TypeApp (TypeApp (TypeCon "Result") (TypeCon "DbError")) (TypeApp (TypeCon "List") (TypeCon "User"))))))}),DeclValue "createUsersHelper" [PVar "conn",PVar "remaining",PVar "created"] (Case (Var "remaining") [Alt (PCon "Nil" []) (App (Var "pure") (App (Var "Ok") (Var "created"))),Alt (PCon "Cons" [PVar "u",PVar "rest"]) (DoBlock [BindStmt (PVar "insertQuery") (App (Var "pure") (App (FieldAccess (Var "Query") "returning") (App (App (FieldAccess (Var "Query") "values") (App (App (Var "Cons") (App (App (FieldAccess (Var "Query") "set") (Var "users_name")) (App (FieldAccess (Var "Database") "string") (FieldAccess (Var "u") "name")))) (App (App (Var "Cons") (App (App (FieldAccess (Var "Query") "set") (Var "users_email")) (App (FieldAccess (Var "Database") "string") (FieldAccess (Var "u") "email")))) (Var "Nil")))) (App (App (FieldAccess (Var "Query") "insert") (Var "users")) (Var "userDecoder"))))),BindStmt (PVar "result") (App (App (FieldAccess (Var "Postgres") "run") (Var "conn")) (Var "insertQuery")),ExprStmt (Case (Var "result") [Alt (PCon "Err" [PVar "e"]) (App (Var "pure") (App (Var "Err") (Var "e"))),Alt (PCon "Ok" [PVar "inserted"]) (Case (Var "inserted") [Alt (PCon "Nil" []) (App (Var "pure") (App (Var "Err") (App (Var "QueryFailed") (StringLit "Insert returned no rows")))),Alt (PCon "Cons" [PVar "user",PWildcard]) (App (App (App (Var "createUsersHelper") (Var "conn")) (Var "rest")) (App (App (Var "Cons") (Var "user")) (Var "created")))])])])]),DeclTypeSig "main" (QualType {qualConstraints = [], qualType = TypeApp (TypeCon "IO") (TypeCon "Unit")}),DeclValue "main" [] (DoBlock [ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "=== Transaction Examples ===")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "This example demonstrates the transaction API.")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "1. Manual transaction control:")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "   Postgres.begin conn")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "   -- run queries --")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "   Postgres.commit conn  -- or Postgres.rollback conn")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "2. Automatic transaction wrapper:")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "   Postgres.transaction conn (\\tx ->")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "     do")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "       result1 <- Postgres.run tx query1")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "       result2 <- Postgres.run tx query2")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "       pure (Ok result))")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "   -- Commits on Ok, rolls back on Err")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "3. Type signature:")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "   transaction : DbConn -> (DbConn -> IO (Result DbError a)) -> IO (Result DbError a)")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "4. Example: Create multiple users atomically")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "   createUsers : DbConn -> List NewUser -> IO (Result DbError (List User))")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "   createUsers conn newUsers =")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "     Postgres.transaction conn (\\tx ->")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "       -- insert each user, rollback if any fails")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "       createUsersHelper tx newUsers Nil)")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "Done!"))])]}
