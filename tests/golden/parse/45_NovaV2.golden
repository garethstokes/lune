Module {modName = "NovaV2Demo", modExports = [ExposeValue "main"], modImports = [Import {impName = "Lune.IO", impAs = Just "IO", impExposing = Nothing},Import {impName = "Lune.Task", impAs = Just "Task", impExposing = Nothing},Import {impName = "Lune.String", impAs = Just "Str", impExposing = Nothing},Import {impName = "Lune.Int", impAs = Just "Int", impExposing = Nothing},Import {impName = "Lune.Json", impAs = Just "RawJson", impExposing = Just [ExposeType "Json" ExposeOpaque]},Import {impName = "Lune.Json.Decode", impAs = Just "Decode", impExposing = Nothing},Import {impName = "Lune.Json.Encode", impAs = Just "Encode", impExposing = Nothing},Import {impName = "Nova", impAs = Nothing, impExposing = Just [ExposeValue "newClient",ExposeValue "provider",ExposeValue "withHooks",ExposeValue "withModel",ExposeValue "ask",ExposeValue "json",ExposeValue "tool",ExposeValue "askStream",ExposeValue "next",ExposeType "StreamStep" ExposeAll,ExposeType "NovaEvent" ExposeAll,ExposeValue "executeTool"]},Import {impName = "Nova.Core", impAs = Just "Core", impExposing = Just [ExposeType "Error" ExposeAll,ExposeType "Provider" ExposeOpaque,ExposeType "ProviderConfig" ExposeOpaque,ExposeType "Response" ExposeOpaque,ExposeType "ProviderImpl" ExposeOpaque,ExposeType "Capability" ExposeAll,ExposeType "Set" ExposeOpaque,ExposeType "Usage" ExposeOpaque]},Import {impName = "Nova.Tool", impAs = Just "Tool", impExposing = Nothing},Import {impName = "Nova.Runtime", impAs = Just "Runtime", impExposing = Just [ExposeType "RuntimeConfig" ExposeOpaque,ExposeType "ToolExecError" ExposeAll]}], modDecls = [DeclTypeSig "mockProvider" (QualType {qualConstraints = [], qualType = TypeCon "Provider"}),DeclValue "mockProvider" [] (App (Var "provider") (StringLit "mock")),DeclValue "mockCall" [PWildcard,PVar "model",PVar "prompt"] (Case (Var "model") [Alt (PString "echo") (App (App (Var "<|") (Var "prim_ioPure")) (App (Var "Ok") (RecordLiteral [("text",Var "prompt"),("usage",App (Var "Just") (RecordLiteral [("inputTokens",IntLit 0),("outputTokens",IntLit 0),("totalTokens",IntLit 0)]))]))),Alt (PString "json") (App (App (Var "<|") (Var "prim_ioPure")) (App (Var "Ok") (RecordLiteral [("text",StringLit "{\"n\":1}"),("usage",App (Var "Just") (RecordLiteral [("inputTokens",IntLit 0),("outputTokens",IntLit 0),("totalTokens",IntLit 0)]))]))),Alt (PString "tool") (App (App (Var "<|") (Var "prim_ioPure")) (App (Var "Ok") (RecordLiteral [("text",StringLit "ok\n{\"n\":2}\nbye"),("usage",App (Var "Just") (RecordLiteral [("inputTokens",IntLit 0),("outputTokens",IntLit 0),("totalTokens",IntLit 0)]))]))),Alt PWildcard (App (Var "prim_ioPure") (App (Var "Err") (App (Var "ProviderError") (StringLit "Unknown model"))))]),DeclValue "mockProviderImpl" [] (RecordLiteral [("id",Var "mockProvider"),("call",Var "mockCall"),("capabilities",FieldAccess (Var "Core") "setEmpty")]),DeclTypeSig "hooks" (QualType {qualConstraints = [], qualType = TypeCon "Nova.NovaHooks"}),DeclValue "hooks" [] (RecordLiteral [("onTurn",Lam [PWildcard] (App (FieldAccess (Var "IO") "println") (StringLit "hook:onTurn"))),("onToolStart",Lam [PVar "ctx"] (App (App (Var "|>") (App (App (FieldAccess (Var "Str") "append") (StringLit "hook:onToolStart ")) (App (FieldAccess (Var "Tool") "toolIdToString") (FieldAccess (Var "ctx") "tool")))) (FieldAccess (Var "IO") "println"))),("onToolFinish",Lam [PVar "ctx"] (App (App (Var "|>") (App (App (FieldAccess (Var "Str") "append") (StringLit "hook:onToolFinish ")) (App (FieldAccess (Var "Tool") "toolIdToString") (FieldAccess (Var "ctx") "tool")))) (FieldAccess (Var "IO") "println")))]),DeclTypeAlias [] "AddArgs" [] (TypeRecord [("a",TypeCon "Int",[]),("b",TypeCon "Int",[])]),DeclTypeSig "addSpec" (QualType {qualConstraints = [], qualType = TypeApp (TypeCon "Tool.ToolSpec") (TypeCon "AddArgs")}),DeclValue "addSpec" [] (RecordLiteral [("id",App (App (FieldAccess (Var "Tool") "toolId") (StringLit "add")) (StringLit "1")),("description",StringLit "Add two integers."),("schema",App (FieldAccess (Var "Encode") "object") (App (App (Var "Cons") (RecordLiteral [("key",StringLit "type"),("value",App (FieldAccess (Var "Encode") "string") (StringLit "object"))])) (App (App (Var "Cons") (RecordLiteral [("key",StringLit "required"),("value",App (App (FieldAccess (Var "Encode") "list") (FieldAccess (Var "Encode") "string")) (App (App (Var "Cons") (StringLit "a")) (App (App (Var "Cons") (StringLit "b")) (Var "Nil"))))])) (Var "Nil")))),("decoder",App (FieldAccess (Var "Tool") "decodeJsonString") (App (App (App (FieldAccess (Var "Decode") "map2") (Lam [PVar "a",PVar "b"] (RecordLiteral [("a",Var "a"),("b",Var "b")]))) (App (App (FieldAccess (Var "Decode") "field") (StringLit "a")) (FieldAccess (Var "Decode") "int"))) (App (App (FieldAccess (Var "Decode") "field") (StringLit "b")) (FieldAccess (Var "Decode") "int"))))]),DeclTypeSig "runtimeAllow" (QualType {qualConstraints = [], qualType = TypeCon "RuntimeConfig"}),DeclValue "runtimeAllow" [] (RecordLiteral [("maxTurns",IntLit 3),("toolTimeoutMs",IntLit 250),("allowedTools",App (App (FieldAccess (Var "Core") "setFromList") (FieldAccess (Var "Tool") "eqToolId")) (App (App (Var "Cons") (FieldAccess (Var "addSpec") "id")) (Var "Nil"))),("requireApproval",FieldAccess (Var "Core") "setEmpty")]),DeclTypeSig "runtimeDeny" (QualType {qualConstraints = [], qualType = TypeCon "RuntimeConfig"}),DeclValue "runtimeDeny" [] (RecordUpdate (Var "runtimeAllow") [("allowedTools",FieldAccess (Var "Core") "setEmpty")]),DeclTypeSig "runAdd" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "AddArgs") (TypeApp (TypeApp (TypeCon "Task") (TypeCon "ToolExecError")) (TypeCon "Int"))}),DeclValue "runAdd" [PVar "args"] (App (FieldAccess (Var "Task") "succeed") (App (App (FieldAccess (Var "Int") "add") (FieldAccess (Var "args") "a")) (FieldAccess (Var "args") "b"))),DeclTypeSig "encodeAddArgs" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "AddArgs") (TypeCon "Json")}),DeclValue "encodeAddArgs" [PVar "args"] (App (FieldAccess (Var "Encode") "object") (App (App (Var "Cons") (RecordLiteral [("key",StringLit "a"),("value",App (FieldAccess (Var "Encode") "int") (FieldAccess (Var "args") "a"))])) (App (App (Var "Cons") (RecordLiteral [("key",StringLit "b"),("value",App (FieldAccess (Var "Encode") "int") (FieldAccess (Var "args") "b"))])) (Var "Nil")))),DeclTypeSig "main" (QualType {qualConstraints = [], qualType = TypeApp (TypeApp (TypeCon "Task") (TypeCon "Unit")) (TypeCon "Unit")}),DeclValue "main" [] (DoBlock [LetStmt "providers" (App (App (App (App (FieldAccess (Var "Core") "dictInsert") (FieldAccess (Var "Nova") "providerEq")) (Var "mockProvider")) (Var "mockProviderImpl")) (FieldAccess (Var "Core") "defaultProviderRegistry")),LetStmt "client" (App (App (Var "withHooks") (Var "hooks")) (App (App (App (Var "newClient") (Var "providers")) (Var "mockProvider")) (StringLit "echo"))),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "ask:")),BindStmt (PVar "a") (App (FieldAccess (Var "Task") "fromIO") (App (FieldAccess (Var "Task") "attempt") (App (App (Var "ask") (Var "client")) (StringLit "Hello from Nova v2")))),ExprStmt (App (App (Var "<|") (FieldAccess (Var "IO") "println")) (App (FieldAccess (Var "Nova") "showAskResult") (Var "a"))),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "json:")),BindStmt (PVar "j") (App (FieldAccess (Var "Task") "fromIO") (App (FieldAccess (Var "Task") "attempt") (App (App (Var "json") (App (App (Var "withModel") (StringLit "json")) (Var "client"))) (StringLit "ignored")))),ExprStmt (App (App (Var "<|") (FieldAccess (Var "IO") "println")) (App (FieldAccess (Var "Nova") "showJsonResult") (Var "j"))),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "tool:")),BindStmt (PVar "t") (App (FieldAccess (Var "Task") "fromIO") (App (FieldAccess (Var "Task") "attempt") (App (App (Var "tool") (App (App (Var "withModel") (StringLit "tool")) (Var "client"))) (StringLit "ignored")))),ExprStmt (App (App (Var "<|") (FieldAccess (Var "IO") "println")) (App (FieldAccess (Var "Nova") "showJsonResult") (Var "t"))),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "askStream:")),LetStmt "stream" (App (App (Var "askStream") (Var "client")) (StringLit "This is a longer string to demonstrate simulated streaming.")),BindStmt (PVar "s1") (App (App (Var "<|") (FieldAccess (Var "Task") "fromIO")) (App (Var "next") (Var "stream"))),ExprStmt (App (App (Var "<|") (FieldAccess (Var "IO") "println")) (App (App (App (FieldAccess (Var "Nova") "showStreamResult") (FieldAccess (Var "Nova") "showError")) (FieldAccess (Var "Nova") "showEvent")) (Var "s1"))),ExprStmt (Case (Var "s1") [Alt (PCon "Err" [PWildcard]) (App (FieldAccess (Var "Task") "succeed") (Var "unit")),Alt (PCon "Ok" [PCon "StreamEnd" []]) (App (FieldAccess (Var "Task") "succeed") (Var "unit")),Alt (PCon "Ok" [PCon "StreamYield" [PWildcard,PVar "rest"]]) (DoBlock [BindStmt (PVar "s2") (App (App (Var "<|") (FieldAccess (Var "Task") "fromIO")) (App (Var "next") (Var "rest"))),ExprStmt (App (App (Var "<|") (FieldAccess (Var "IO") "println")) (App (App (App (FieldAccess (Var "Nova") "showStreamResult") (FieldAccess (Var "Nova") "showError")) (FieldAccess (Var "Nova") "showEvent")) (Var "s2"))),ExprStmt (App (FieldAccess (Var "Task") "succeed") (Var "unit"))])]),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "executeTool_allow:")),BindStmt (PVar "r1") (App (Var "toResult") (App (App (App (App (App (App (App (Var "executeTool") (Var "client")) (Var "runtimeAllow")) (Var "addSpec")) (Var "encodeAddArgs")) (FieldAccess (Var "Encode") "int")) (Var "runAdd")) (RecordLiteral [("a",IntLit 1),("b",IntLit 2)]))),ExprStmt (App (App (Var "<|") (FieldAccess (Var "IO") "println")) (App (FieldAccess (Var "Nova") "showToolExecResult") (Var "r1"))),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "executeTool_deny:")),BindStmt (PVar "r2") (App (Var "toResult") (App (App (App (App (App (App (App (Var "executeTool") (Var "client")) (Var "runtimeDeny")) (Var "addSpec")) (Var "encodeAddArgs")) (FieldAccess (Var "Encode") "int")) (Var "runAdd")) (RecordLiteral [("a",IntLit 1),("b",IntLit 2)]))),ExprStmt (App (App (Var "<|") (FieldAccess (Var "IO") "println")) (App (FieldAccess (Var "Nova") "showToolExecResult") (Var "r2")))]),DeclTypeSig "toResult" (QualType {qualConstraints = [], qualType = TypeArrow (TypeApp (TypeApp (TypeCon "Task") (TypeVar "e")) (TypeVar "a")) (TypeApp (TypeApp (TypeCon "Task") (TypeVar "x")) (TypeApp (TypeApp (TypeCon "Result") (TypeVar "e")) (TypeVar "a")))}),DeclValue "toResult" [PVar "task"] (App (App (FieldAccess (Var "Task") "onError") (App (App (FieldAccess (Var "Task") "map") (Var "Ok")) (Var "task"))) (Lam [PVar "e"] (App (FieldAccess (Var "Task") "succeed") (App (Var "Err") (Var "e")))))]}
