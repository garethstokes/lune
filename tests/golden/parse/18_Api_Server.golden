Module {modName = "ApiServer", modExports = [ExposeValue "main"], modImports = [Import {impName = "Lune.Http.Api", impAs = Just "Api", impExposing = Nothing},Import {impName = "Lune.Http.Api", impAs = Nothing, impExposing = Just [ExposeType "ServerConfig" ExposeOpaque,ExposeType "Routes" ExposeOpaque]},Import {impName = "Lune.Http.Route", impAs = Just "Route", impExposing = Nothing},Import {impName = "Lune.Http", impAs = Nothing, impExposing = Just [ExposeType "Request" ExposeOpaque,ExposeType "Response" ExposeOpaque,ExposeType "Method" ExposeAll]},Import {impName = "Lune.Json", impAs = Just "Json", impExposing = Nothing},Import {impName = "Lune.Json.Encode", impAs = Just "E", impExposing = Nothing},Import {impName = "Lune.Task", impAs = Just "Task", impExposing = Nothing}], modDecls = [DeclType "AppError" [] [TypeCtor "NotFound" [TypeCon "String"],TypeCtor "BadRequest" [TypeCon "String"]],DeclTypeAlias [] "Context" [] (TypeRecord [("appName",TypeCon "String",[])]),DeclTypeAlias [] "User" [] (TypeRecord [("id",TypeCon "Int",[]),("name",TypeCon "String",[])]),DeclTypeSig "encodeUser" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "User") (TypeCon "Json.Json")}),DeclValue "encodeUser" [PVar "user"] (App (FieldAccess (Var "E") "object") (App (App (Var "Cons") (RecordLiteral [("key",StringLit "id"),("value",App (FieldAccess (Var "E") "int") (FieldAccess (Var "user") "id"))])) (App (App (Var "Cons") (RecordLiteral [("key",StringLit "name"),("value",App (FieldAccess (Var "E") "string") (FieldAccess (Var "user") "name"))])) (Var "Nil")))),DeclTypeAlias [] "HealthStatus" [] (TypeRecord [("status",TypeCon "String",[])]),DeclTypeSig "encodeHealth" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "HealthStatus") (TypeCon "Json.Json")}),DeclValue "encodeHealth" [PVar "h"] (App (FieldAccess (Var "E") "object") (App (App (Var "Cons") (RecordLiteral [("key",StringLit "status"),("value",App (FieldAccess (Var "E") "string") (FieldAccess (Var "h") "status"))])) (Var "Nil"))),DeclTypeAlias [] "ErrorResponse" [] (TypeRecord [("error",TypeCon "String",[])]),DeclTypeSig "encodeError" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "ErrorResponse") (TypeCon "Json.Json")}),DeclValue "encodeError" [PVar "e"] (App (FieldAccess (Var "E") "object") (App (App (Var "Cons") (RecordLiteral [("key",StringLit "error"),("value",App (FieldAccess (Var "E") "string") (FieldAccess (Var "e") "error"))])) (Var "Nil"))),DeclTypeSig "jsonResponse" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "Int") (TypeArrow (TypeCon "Json.Json") (TypeCon "Response"))}),DeclValue "jsonResponse" [PVar "status",PVar "body"] (RecordLiteral [("status",Var "status"),("headers",App (App (Var "Cons") (RecordLiteral [("key",StringLit "Content-Type"),("value",StringLit "application/json")])) (Var "Nil")),("body",App (FieldAccess (Var "Json") "stringify") (Var "body"))]),DeclTypeSig "errorToResponse" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "AppError") (TypeCon "Response")}),DeclValue "errorToResponse" [PVar "err"] (Case (Var "err") [Alt (PCon "NotFound" [PVar "msg"]) (App (App (Var "jsonResponse") (IntLit 404)) (App (Var "encodeError") (RecordLiteral [("error",Var "msg")]))),Alt (PCon "BadRequest" [PVar "msg"]) (App (App (Var "jsonResponse") (IntLit 400)) (App (Var "encodeError") (RecordLiteral [("error",Var "msg")])))]),DeclTypeSig "routes" (QualType {qualConstraints = [], qualType = TypeApp (TypeApp (TypeCon "Routes") (TypeCon "AppError")) (TypeCon "Context")}),DeclValue "routes" [] (App (FieldAccess (Var "Route") "define") (App (App (Var "Cons") (App (App (FieldAccess (Var "Route") "get") (StringLit "/health")) (Var "healthHandler"))) (App (App (Var "Cons") (App (App (FieldAccess (Var "Route") "get") (StringLit "/users/:id")) (Var "getUserHandler"))) (App (App (Var "Cons") (App (App (FieldAccess (Var "Route") "post") (StringLit "/users")) (Var "createUserHandler"))) (Var "Nil"))))),DeclTypeSig "healthHandler" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "Request") (TypeArrow (TypeCon "Context") (TypeApp (TypeApp (TypeCon "Task") (TypeCon "AppError")) (TypeCon "Response")))}),DeclValue "healthHandler" [PVar "request",PVar "ctx"] (App (FieldAccess (Var "Api") "pure") (App (App (Var "jsonResponse") (IntLit 200)) (App (Var "encodeHealth") (RecordLiteral [("status",StringLit "ok")])))),DeclTypeSig "getUserHandler" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "Request") (TypeArrow (TypeCon "Context") (TypeApp (TypeApp (TypeCon "Task") (TypeCon "AppError")) (TypeCon "Response")))}),DeclValue "getUserHandler" [PVar "request",PVar "ctx"] (App (FieldAccess (Var "Api") "pure") (App (App (Var "jsonResponse") (IntLit 200)) (App (Var "encodeUser") (RecordLiteral [("id",IntLit 123),("name",StringLit "Alice")])))),DeclTypeSig "createUserHandler" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "Request") (TypeArrow (TypeCon "Context") (TypeApp (TypeApp (TypeCon "Task") (TypeCon "AppError")) (TypeCon "Response")))}),DeclValue "createUserHandler" [PVar "request",PVar "ctx"] (App (FieldAccess (Var "Api") "pure") (App (App (Var "jsonResponse") (IntLit 201)) (App (Var "encodeUser") (RecordLiteral [("id",IntLit 456),("name",StringLit "Created")])))),DeclTypeSig "config" (QualType {qualConstraints = [], qualType = TypeApp (TypeApp (TypeCon "ServerConfig") (TypeCon "AppError")) (TypeCon "Context")}),DeclValue "config" [] (RecordLiteral [("port",IntLit 8080),("errorHandler",Var "errorToResponse"),("context",RecordLiteral [("appName",StringLit "MyApp")])]),DeclTypeSig "main" (QualType {qualConstraints = [], qualType = TypeApp (TypeApp (TypeCon "Task") (TypeCon "Unit")) (TypeCon "Unit")}),DeclValue "main" [] (App (App (FieldAccess (Var "Task") "onError") (App (App (FieldAccess (Var "Api") "serve") (Var "config")) (Var "routes"))) (Lam [PWildcard] (App (FieldAccess (Var "Task") "succeed") (Var "unit"))))]}
