Module {modName = "DeriveJson", modExports = [ExposeValue "main"], modImports = [Import {impName = "Lune.IO", impAs = Just "IO", impExposing = Nothing},Import {impName = "Lune.Json", impAs = Just "Json", impExposing = Nothing},Import {impName = "Lune.String", impAs = Just "Str", impExposing = Nothing},Import {impName = "Lune.Prelude", impAs = Nothing, impExposing = Just [ExposeType "Int" ExposeOpaque,ExposeType "List" ExposeAll,ExposeType "Maybe" ExposeAll,ExposeType "Result" ExposeAll,ExposeType "String" ExposeOpaque,ExposeType "Task" ExposeOpaque,ExposeType "Unit" ExposeOpaque]}], modDecls = [DeclTypeAlias [Annotation {annName = "derive", annArgs = Just (Var "Json")}] "Product" [] (TypeRecord [("id",TypeCon "Int",[]),("name",TypeCon "String",[]),("tags",TypeApp (TypeCon "List") (TypeCon "String"),[]),("description",TypeApp (TypeCon "Maybe") (TypeCon "String"),[])]),DeclTypeAnn [Annotation {annName = "derive", annArgs = Just (Var "Json")}] "Model" [] [TypeCtor "Echo" [],TypeCtor "Add" [TypeCon "Int",TypeCon "Int"],TypeCtor "SetName" [TypeCon "String"],TypeCtor "User" [TypeRecord [("id",TypeCon "Int",[]),("name",TypeCon "String",[])]]],DeclTypeSig "main" (QualType {qualConstraints = [], qualType = TypeApp (TypeApp (TypeCon "Task") (TypeCon "Unit")) (TypeCon "Unit")}),DeclValue "main" [] (DoBlock [ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "=== Derive Json ===")),ExprStmt (Var "demoProduct"),ExprStmt (Var "demoModel"),ExprStmt (Var "demoUnknownTag")]),DeclTypeSig "demoProduct" (QualType {qualConstraints = [], qualType = TypeApp (TypeApp (TypeCon "Task") (TypeCon "Unit")) (TypeCon "Unit")}),DeclValue "demoProduct" [] (DoBlock [LetStmt "p" (RecordLiteral [("id",IntLit 1),("name",StringLit "Widget"),("tags",App (App (Var "Cons") (StringLit "sale")) (App (App (Var "Cons") (StringLit "new")) (Var "Nil"))),("description",Var "Nothing")]),LetStmt "json" (App (Var "productEncoder") (Var "p")),ExprStmt (App (FieldAccess (Var "IO") "println") (App (App (FieldAccess (Var "Str") "append") (StringLit "Product JSON: ")) (App (FieldAccess (Var "Json") "stringify") (Var "json")))),ExprStmt (Case (App (App (FieldAccess (Var "D") "decodeValue") (Var "productDecoder")) (Var "json")) [Alt (PCon "Err" [PVar "err"]) (App (FieldAccess (Var "IO") "println") (App (App (FieldAccess (Var "Str") "append") (StringLit "Product decode error: ")) (FieldAccess (Var "err") "message"))),Alt (PCon "Ok" [PVar "p2"]) (App (FieldAccess (Var "IO") "println") (App (App (FieldAccess (Var "Str") "append") (StringLit "Decoded product name: ")) (FieldAccess (Var "p2") "name")))])]),DeclTypeSig "demoModel" (QualType {qualConstraints = [], qualType = TypeApp (TypeApp (TypeCon "Task") (TypeCon "Unit")) (TypeCon "Unit")}),DeclValue "demoModel" [] (DoBlock [ExprStmt (App (Var "roundtripModel") (Var "Echo")),ExprStmt (App (Var "roundtripModel") (App (App (Var "Add") (IntLit 1)) (IntLit 2))),ExprStmt (App (Var "roundtripModel") (App (Var "SetName") (StringLit "Alice"))),ExprStmt (App (Var "roundtripModel") (App (Var "User") (RecordLiteral [("id",IntLit 1),("name",StringLit "Bob")])))]),DeclTypeSig "roundtripModel" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "Model") (TypeApp (TypeApp (TypeCon "Task") (TypeCon "Unit")) (TypeCon "Unit"))}),DeclValue "roundtripModel" [PVar "m"] (DoBlock [LetStmt "json" (App (Var "modelEncoder") (Var "m")),ExprStmt (App (FieldAccess (Var "IO") "println") (App (App (FieldAccess (Var "Str") "append") (StringLit "Model JSON: ")) (App (FieldAccess (Var "Json") "stringify") (Var "json")))),ExprStmt (Case (App (App (FieldAccess (Var "D") "decodeValue") (Var "modelDecoder")) (Var "json")) [Alt (PCon "Err" [PVar "err"]) (App (FieldAccess (Var "IO") "println") (App (App (FieldAccess (Var "Str") "append") (StringLit "Model decode error: ")) (FieldAccess (Var "err") "message"))),Alt (PCon "Ok" [PVar "m2"]) (Case (Var "m2") [Alt (PCon "Echo" []) (App (FieldAccess (Var "IO") "println") (StringLit "Decoded: Echo")),Alt (PCon "Add" [PVar "a",PVar "b"]) (App (FieldAccess (Var "IO") "println") (App (App (FieldAccess (Var "Str") "append") (StringLit "Decoded: Add ")) (App (App (FieldAccess (Var "Str") "append") (App (FieldAccess (Var "Str") "fromInt") (Var "a"))) (App (App (FieldAccess (Var "Str") "append") (StringLit " ")) (App (FieldAccess (Var "Str") "fromInt") (Var "b")))))),Alt (PCon "SetName" [PVar "s"]) (App (FieldAccess (Var "IO") "println") (App (App (FieldAccess (Var "Str") "append") (StringLit "Decoded: SetName ")) (Var "s"))),Alt (PCon "User" [PVar "u"]) (App (FieldAccess (Var "IO") "println") (App (App (FieldAccess (Var "Str") "append") (StringLit "Decoded: User ")) (FieldAccess (Var "u") "name")))])])]),DeclTypeSig "demoUnknownTag" (QualType {qualConstraints = [], qualType = TypeApp (TypeApp (TypeCon "Task") (TypeCon "Unit")) (TypeCon "Unit")}),DeclValue "demoUnknownTag" [] (Case (App (FieldAccess (Var "Json") "parse") (StringLit "{\"tag\":\"Nope\",\"fields\":[]}")) [Alt (PCon "Err" [PVar "msg"]) (App (FieldAccess (Var "IO") "println") (App (App (FieldAccess (Var "Str") "append") (StringLit "Parse error: ")) (Var "msg"))),Alt (PCon "Ok" [PVar "json"]) (Case (App (App (FieldAccess (Var "D") "decodeValue") (Var "modelDecoder")) (Var "json")) [Alt (PCon "Ok" [PWildcard]) (App (FieldAccess (Var "IO") "println") (StringLit "Unexpected success decoding unknown tag")),Alt (PCon "Err" [PVar "err"]) (App (FieldAccess (Var "IO") "println") (App (App (FieldAccess (Var "Str") "append") (StringLit "Unknown tag error: ")) (FieldAccess (Var "err") "message")))])])]}
