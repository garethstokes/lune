Module {modName = "Scheduler", modExports = [ExposeValue "main"], modImports = [Import {impName = "Lune.Prelude", impAs = Nothing, impExposing = Just [ExposeType "Task" ExposeOpaque,ExposeType "Result" ExposeAll,ExposeType "Unit" ExposeOpaque,ExposeValue "unit",ExposeType "Int" ExposeOpaque]},Import {impName = "Lune.IO", impAs = Just "IO", impExposing = Nothing},Import {impName = "Lune.Scheduler", impAs = Just "Scheduler", impExposing = Just [ExposeType "Scheduler" ExposeOpaque,ExposeType "JobId" ExposeAll,ExposeType "Schedule" ExposeAll,ExposeType "Concurrency" ExposeAll,ExposeType "JobSpec" ExposeOpaque,ExposeType "SchedulerError" ExposeOpaque]},Import {impName = "Lune.Task", impAs = Just "Task", impExposing = Nothing}], modDecls = [DeclTypeSig "main" (QualType {qualConstraints = [], qualType = TypeApp (TypeApp (TypeCon "Task") (TypeCon "Unit")) (TypeCon "Unit")}),DeclValue "main" [] (DoBlock [DiscardBindStmt (App (FieldAccess (Var "IO") "println") (StringLit "Creating scheduler...")),BindStmt (PVar "sched") (FieldAccess (Var "Scheduler") "new"),DiscardBindStmt (App (FieldAccess (Var "IO") "println") (StringLit "Registering periodic job...")),DiscardBindStmt (App (Var "registerTick") (Var "sched")),DiscardBindStmt (App (FieldAccess (Var "IO") "println") (StringLit "Registering one-shot job...")),DiscardBindStmt (App (Var "registerOneshot") (Var "sched")),DiscardBindStmt (App (FieldAccess (Var "IO") "println") (StringLit "Registering manual job...")),DiscardBindStmt (App (Var "registerManual") (Var "sched")),DiscardBindStmt (App (FieldAccess (Var "IO") "println") (StringLit "Starting scheduler...")),DiscardBindStmt (App (FieldAccess (Var "Scheduler") "start") (Var "sched")),DiscardBindStmt (App (FieldAccess (Var "IO") "sleepMs") (IntLit 3000)),DiscardBindStmt (App (FieldAccess (Var "IO") "println") (StringLit "Triggering manual job...")),DiscardBindStmt (App (App (FieldAccess (Var "Task") "onError") (App (App (FieldAccess (Var "Scheduler") "trigger") (Var "sched")) (App (Var "JobId") (StringLit "manual")))) (Lam [PVar "e"] (App (FieldAccess (Var "Task") "succeed") (Var "unit")))),DiscardBindStmt (App (FieldAccess (Var "IO") "sleepMs") (IntLit 2000)),DiscardBindStmt (App (FieldAccess (Var "IO") "println") (StringLit "Stopping scheduler...")),DiscardBindStmt (App (FieldAccess (Var "Scheduler") "stop") (Var "sched")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "Done!"))]),DeclTypeSig "registerTick" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "Scheduler") (TypeApp (TypeApp (TypeCon "Task") (TypeCon "Unit")) (TypeCon "Unit"))}),DeclValue "registerTick" [PVar "sched"] (App (App (FieldAccess (Var "Task") "onError") (DoBlock [DiscardBindStmt (App (App (FieldAccess (Var "Scheduler") "register") (Var "sched")) (RecordLiteral [("id",App (Var "JobId") (StringLit "tick")),("schedule",App (Var "EveryMs") (IntLit 1000)),("concurrency",Var "OneInstance"),("action",App (FieldAccess (Var "IO") "println") (StringLit "  tick!"))])),ExprStmt (App (FieldAccess (Var "Task") "succeed") (Var "unit"))])) (Lam [PVar "e"] (App (FieldAccess (Var "Task") "succeed") (Var "unit")))),DeclTypeSig "registerOneshot" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "Scheduler") (TypeApp (TypeApp (TypeCon "Task") (TypeCon "Unit")) (TypeCon "Unit"))}),DeclValue "registerOneshot" [PVar "sched"] (App (App (FieldAccess (Var "Task") "onError") (DoBlock [DiscardBindStmt (App (App (FieldAccess (Var "Scheduler") "register") (Var "sched")) (RecordLiteral [("id",App (Var "JobId") (StringLit "oneshot")),("schedule",App (Var "AfterMs") (IntLit 2500)),("concurrency",Var "AllowConcurrent"),("action",App (FieldAccess (Var "IO") "println") (StringLit "  oneshot fired!"))])),ExprStmt (App (FieldAccess (Var "Task") "succeed") (Var "unit"))])) (Lam [PVar "e"] (App (FieldAccess (Var "Task") "succeed") (Var "unit")))),DeclTypeSig "registerManual" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "Scheduler") (TypeApp (TypeApp (TypeCon "Task") (TypeCon "Unit")) (TypeCon "Unit"))}),DeclValue "registerManual" [PVar "sched"] (App (App (FieldAccess (Var "Task") "onError") (DoBlock [DiscardBindStmt (App (App (FieldAccess (Var "Scheduler") "register") (Var "sched")) (RecordLiteral [("id",App (Var "JobId") (StringLit "manual")),("schedule",Var "Manual"),("concurrency",Var "OneInstance"),("action",App (FieldAccess (Var "IO") "println") (StringLit "  manual job executed!"))])),ExprStmt (App (FieldAccess (Var "Task") "succeed") (Var "unit"))])) (Lam [PVar "e"] (App (FieldAccess (Var "Task") "succeed") (Var "unit"))))]}
