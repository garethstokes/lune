Module {modName = "EchoServer", modExports = [ExposeValue "main"], modImports = [Import {impName = "Lune.IO", impAs = Just "IO", impExposing = Nothing},Import {impName = "Lune.Net.Socket", impAs = Just "Socket", impExposing = Nothing},Import {impName = "Lune.Task", impAs = Just "Task", impExposing = Nothing},Import {impName = "Lune.String", impAs = Just "Str", impExposing = Nothing}], modDecls = [DeclTypeSig "main" (QualType {qualConstraints = [], qualType = TypeApp (TypeApp (TypeCon "Task") (TypeCon "Unit")) (TypeCon "Unit")}),DeclValue "main" [] (DoBlock [ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "Starting echo server on port 8080...")),ExprStmt (App (App (FieldAccess (Var "Task") "onError") (DoBlock [BindStmt (PVar "sock") (App (FieldAccess (Var "Socket") "listen") (IntLit 8080)),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "Waiting for connection...")),ExprStmt (App (App (FieldAccess (Var "Task") "onError") (DoBlock [BindStmt (PVar "conn") (App (FieldAccess (Var "Socket") "accept") (Var "sock")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "Client connected!")),ExprStmt (App (Var "handleClient") (Var "conn")),DiscardBindStmt (App (App (FieldAccess (Var "Task") "onError") (App (FieldAccess (Var "Socket") "closeConn") (Var "conn"))) (Lam [PWildcard] (App (FieldAccess (Var "Task") "succeed") (Var "unit")))),DiscardBindStmt (App (App (FieldAccess (Var "Task") "onError") (App (FieldAccess (Var "Socket") "closeSocket") (Var "sock"))) (Lam [PWildcard] (App (FieldAccess (Var "Task") "succeed") (Var "unit")))),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "Server shutdown"))])) (Lam [PWildcard] (App (FieldAccess (Var "IO") "println") (StringLit "Accept failed"))))])) (Lam [PWildcard] (App (FieldAccess (Var "IO") "println") (StringLit "Failed to listen"))))]),DeclTypeSig "handleClient" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "Socket.Connection") (TypeApp (TypeApp (TypeCon "Task") (TypeCon "Error")) (TypeCon "Unit"))}),DeclValue "handleClient" [PVar "conn"] (App (App (FieldAccess (Var "Task") "onError") (DoBlock [BindStmt (PVar "msg") (App (FieldAccess (Var "Socket") "recv") (Var "conn")),ExprStmt (Case (App (App (FieldAccess (Var "Str") "eq") (Var "msg")) (StringLit "")) [Alt (PCon "True" []) (App (FieldAccess (Var "IO") "println") (StringLit "Client disconnected")),Alt (PCon "False" []) (DoBlock [ExprStmt (App (FieldAccess (Var "IO") "println") (App (App (FieldAccess (Var "Str") "append") (StringLit "Received: ")) (Var "msg"))),DiscardBindStmt (App (App (FieldAccess (Var "Task") "onError") (App (App (FieldAccess (Var "Socket") "send") (Var "conn")) (App (App (FieldAccess (Var "Str") "append") (StringLit "Echo: ")) (Var "msg")))) (Lam [PWildcard] (App (FieldAccess (Var "Task") "succeed") (Var "unit")))),ExprStmt (App (Var "handleClient") (Var "conn"))])])])) (Lam [PWildcard] (App (FieldAccess (Var "IO") "println") (StringLit "Recv error"))))]}
