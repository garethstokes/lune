Module {modName = "EchoServer", modExports = [ExposeValue "main"], modImports = [Import {impName = "Lune.IO", impAs = Just "IO", impExposing = Nothing},Import {impName = "Lune.Net.Socket", impAs = Just "Socket", impExposing = Nothing},Import {impName = "Lune.String", impAs = Just "Str", impExposing = Nothing},Import {impName = "Lune.Prelude", impAs = Nothing, impExposing = Just [ExposeType "Result" ExposeAll]}], modDecls = [DeclTypeSig "main" (QualType {qualConstraints = [], qualType = TypeApp (TypeCon "IO") (TypeCon "Unit")}),DeclValue "main" [] (DoBlock [ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "Starting echo server on port 8080...")),BindStmt (PVar "socketResult") (App (FieldAccess (Var "Socket") "listen") (IntLit 8080)),ExprStmt (Case (Var "socketResult") [Alt (PCon "Err" [PWildcard]) (App (FieldAccess (Var "IO") "println") (StringLit "Failed to listen")),Alt (PCon "Ok" [PVar "sock"]) (DoBlock [ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "Waiting for connection...")),BindStmt (PVar "connResult") (App (FieldAccess (Var "Socket") "accept") (Var "sock")),ExprStmt (Case (Var "connResult") [Alt (PCon "Err" [PWildcard]) (App (FieldAccess (Var "IO") "println") (StringLit "Accept failed")),Alt (PCon "Ok" [PVar "conn"]) (DoBlock [ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "Client connected!")),ExprStmt (App (Var "handleClient") (Var "conn")),DiscardBindStmt (App (FieldAccess (Var "Socket") "closeConn") (Var "conn")),DiscardBindStmt (App (FieldAccess (Var "Socket") "closeSocket") (Var "sock")),ExprStmt (App (FieldAccess (Var "IO") "println") (StringLit "Server shutdown"))])])])])]),DeclTypeSig "handleClient" (QualType {qualConstraints = [], qualType = TypeArrow (TypeCon "Socket.Connection") (TypeApp (TypeCon "IO") (TypeCon "Unit"))}),DeclValue "handleClient" [PVar "conn"] (DoBlock [BindStmt (PVar "recvResult") (App (FieldAccess (Var "Socket") "recv") (Var "conn")),ExprStmt (Case (Var "recvResult") [Alt (PCon "Err" [PWildcard]) (App (FieldAccess (Var "IO") "println") (StringLit "Recv error")),Alt (PCon "Ok" [PVar "msg"]) (Case (App (App (FieldAccess (Var "Str") "eq") (Var "msg")) (StringLit "")) [Alt (PCon "True" []) (App (FieldAccess (Var "IO") "println") (StringLit "Client disconnected")),Alt (PCon "False" []) (DoBlock [ExprStmt (App (FieldAccess (Var "IO") "println") (App (App (FieldAccess (Var "Str") "append") (StringLit "Received: ")) (Var "msg"))),DiscardBindStmt (App (App (FieldAccess (Var "Socket") "send") (Var "conn")) (App (App (FieldAccess (Var "Str") "append") (StringLit "Echo: ")) (Var "msg"))),ExprStmt (App (Var "handleClient") (Var "conn"))])])])])]}
