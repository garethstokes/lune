Module {modName = "STMExample", modExports = [ExposeValue "main"], modImports = [Import {impName = "Lune.IO", impAs = Just "IO", impExposing = Nothing},Import {impName = "Lune.Atomic", impAs = Just "Atomic", impExposing = Nothing},Import {impName = "Lune.Task", impAs = Just "Task", impExposing = Nothing},Import {impName = "Lune.String", impAs = Just "Str", impExposing = Nothing},Import {impName = "Lune.Int", impAs = Just "Int", impExposing = Nothing},Import {impName = "Lune.Prelude", impAs = Nothing, impExposing = Just [ExposeType "Shared" ExposeOpaque]}], modDecls = [DeclTypeSig "main" (QualType {qualConstraints = [], qualType = TypeApp (TypeCon "IO") (TypeCon "Unit")}),DeclValue "main" [] (DoBlock [BindStmt (PVar "tv") (App (FieldAccess (Var "Atomic") "commit") (App (FieldAccess (Var "Atomic") "new") (IntLit 0))),BindStmt (PVar "t1") (App (FieldAccess (Var "Task") "start") (App (App (Var "incrementN") (Var "tv")) (IntLit 5))),BindStmt (PVar "t2") (App (FieldAccess (Var "Task") "start") (App (App (Var "incrementN") (Var "tv")) (IntLit 5))),DiscardBindStmt (FieldAccess (Var "Task") "yield"),DiscardBindStmt (FieldAccess (Var "Task") "yield"),DiscardBindStmt (App (FieldAccess (Var "Task") "await") (Var "t1")),DiscardBindStmt (App (FieldAccess (Var "Task") "await") (Var "t2")),BindStmt (PVar "n") (App (FieldAccess (Var "Atomic") "commit") (App (FieldAccess (Var "Atomic") "read") (Var "tv"))),ExprStmt (App (FieldAccess (Var "IO") "println") (App (App (FieldAccess (Var "Str") "append") (StringLit "counter=")) (App (FieldAccess (Var "Str") "fromInt") (Var "n"))))]),DeclTypeSig "incrementN" (QualType {qualConstraints = [], qualType = TypeArrow (TypeApp (TypeCon "Shared") (TypeCon "Int")) (TypeArrow (TypeCon "Int") (TypeApp (TypeCon "IO") (TypeCon "Unit")))}),DeclValue "incrementN" [PVar "tv",PVar "count"] (App (App (Var "incrementLoop") (Var "tv")) (Var "count")),DeclTypeSig "incrementLoop" (QualType {qualConstraints = [], qualType = TypeArrow (TypeApp (TypeCon "Shared") (TypeCon "Int")) (TypeArrow (TypeCon "Int") (TypeApp (TypeCon "IO") (TypeCon "Unit")))}),DeclValue "incrementLoop" [PVar "tv",PVar "remaining"] (Case (App (App (FieldAccess (Var "Int") "lte") (Var "remaining")) (IntLit 0)) [Alt (PCon "True" []) (App (FieldAccess (Var "IO") "println") (StringLit "Worker done")),Alt (PCon "False" []) (DoBlock [DiscardBindStmt (App (FieldAccess (Var "Atomic") "commit") (DoBlock [BindStmt (PVar "n") (App (FieldAccess (Var "Atomic") "read") (Var "tv")),ExprStmt (App (App (FieldAccess (Var "Atomic") "write") (Var "tv")) (App (App (FieldAccess (Var "Int") "add") (Var "n")) (IntLit 1)))])),ExprStmt (App (App (Var "incrementLoop") (Var "tv")) (App (App (FieldAccess (Var "Int") "sub") (Var "remaining")) (IntLit 1)))])])]}
