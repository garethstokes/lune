module NovaDemo exposing (main)
import Lune.IO as IO
import Lune.Task as Task
import Lune.String as Str
import Lune.Json as RawJson
import Nova exposing (
  defaultClient
  , withOllamaBaseUrl
  , withProvider
  , withModel
  , openrouter
  , ollama
  , ask
  , json
  , tool
)
import Nova.Core exposing (Error(..))

showError : Error -> String
showError e =
  case e of
    NetworkError msg ->
      Str.append "NetworkError " msg
    RateLimited ->
      "RateLimited"
    Unauthorized ->
      "Unauthorized"
    BadRequest msg ->
      Str.append "BadRequest " msg
    ProviderError msg ->
      Str.append "ProviderError " msg
    DecodeError msg ->
      Str.append "DecodeError " msg

showAskResult : Result Error String -> String
showAskResult r =
  case r of
    Err e ->
      showError e
    Ok s ->
      s

showJsonResult : Result Error RawJson.Json -> String
showJsonResult r =
  case r of
    Err e ->
      showError e
    Ok j ->
      RawJson.stringify j

main : Task Unit Unit
main =
  do
    let baseClient = withOllamaBaseUrl "mock://" defaultClient
    IO.println "routing_openrouter_missing_key:"
    let openrouterClient = withModel "x" (withProvider openrouter baseClient)
    r1 <- Task.fromIO <| ask openrouterClient "hi"
    IO.println <| showAskResult r1
    IO.println "routing_ollama_mock:"
    let pureClient = withModel "mock-pure" (withProvider ollama baseClient)
    r2 <- Task.fromIO <| ask pureClient "hi"
    IO.println <| showAskResult r2
    IO.println "tool_wrapper_counts:"
    let toolWrapperClient = withModel "mock-tool-wrapper" (withProvider ollama baseClient)
    countsR <- Task.fromIO <| tool toolWrapperClient "user"
    IO.println <| showJsonResult countsR
    IO.println "json_pure:"
    jp <- Task.fromIO <| json pureClient "p"
    IO.println <| showJsonResult jp
    IO.println "tool_pure:"
    tp <- Task.fromIO <| tool pureClient "p"
    IO.println <| showJsonResult tp
    IO.println "json_prose_prefix:"
    let prosePrefixClient = withModel "mock-prose-prefix" (withProvider ollama baseClient)
    jpp <- Task.fromIO <| json prosePrefixClient "p"
    IO.println <| showJsonResult jpp
    IO.println "tool_prose_prefix:"
    tpp <- Task.fromIO <| tool prosePrefixClient "p"
    IO.println <| showJsonResult tpp
    IO.println "json_prose_suffix:"
    let proseSuffixClient = withModel "mock-prose-suffix" (withProvider ollama baseClient)
    jps <- Task.fromIO <| json proseSuffixClient "p"
    IO.println <| showJsonResult jps
    IO.println "tool_prose_suffix:"
    tps <- Task.fromIO <| tool proseSuffixClient "p"
    IO.println <| showJsonResult tps
    IO.println "tool_invalid:"
    let invalidClient = withModel "mock-invalid" (withProvider ollama baseClient)
    ti <- Task.fromIO <| tool invalidClient "p"
    IO.println <| showJsonResult ti
    IO.println "tool_no_json:"
    let noJsonClient = withModel "mock-no-json" (withProvider ollama baseClient)
    tn <- Task.fromIO <| tool noJsonClient "p"
    IO.println <| showJsonResult tn
