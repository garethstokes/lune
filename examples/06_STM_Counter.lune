module STMExample exposing (main)

import Lune.IO as IO
import Lune.Atomic as Atomic
import Lune.Fiber as Fiber
import Lune.String as Str
import Lune.Int as Int
import Lune.Prelude exposing (Shared)

main : Task Unit Unit
main =
  do
    tv <- Atomic.commit (Atomic.new 0)
    t1 <- Fiber.spawn (incrementN tv 5)
    t2 <- Fiber.spawn (incrementN tv 5)
    _ <- Fiber.yield
    _ <- Fiber.yield
    _ <- Fiber.await t1
    _ <- Fiber.await t2
    n <- Atomic.commit (Atomic.read tv)
    IO.println (Str.append "counter=" (Str.fromInt n))

incrementN : Shared Int -> Int -> Task Unit Unit
incrementN tv count =
  incrementLoop tv count

incrementLoop : Shared Int -> Int -> Task Unit Unit
incrementLoop tv remaining =
  case Int.lte remaining 0 of
    True ->
      IO.println "Worker done"
    False ->
      do
        _ <- Atomic.commit
          (do
            n <- Atomic.read tv
            Atomic.write tv (Int.add n 1)
          )
        incrementLoop tv (Int.sub remaining 1)
